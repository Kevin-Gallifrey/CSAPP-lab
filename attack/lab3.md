# Code Injection Attacks
## Level 1
`getbuf`中对`%rsp`减了`0x28`，这个40个字节就是用于放入字符串的。`Gets`将输入的字符串写入栈中，起始地址为`0x5561dc78`。`getbuf`的返回地址放在以`0x5561dca0`为首的地址中，共8个字节。  
要让`getbuf`返回到`touch1`，就是要将栈中`0x5561dca0`处的返回地址覆盖成`touch1`的地址。输入字符串的前40个字符可以为任意值，之后接`touch1`的地址即可。  
注意字节顺序是little-endian，在输入地址时，从低到高。

## Level 2
需要注入一段代码，将cookie值存入`%rdi`中，在用`ret`，跳转到`touch2`。用`ret`实现跳转，只需要将地址放入栈中，并保证在`ret`执行前，`%rsp`指向该地址，这样就可以将其作为返回地址，实现跳转。  
需要注入三行代码，分别是`mov`(cookie存入`%rdi`)，`push`(`touch2`地址压栈)，`ret`。  
此时将`getbuf`的返回地址覆盖成`mov`指令的所在地址即可，如输入字符串一开始就是注入代码的编码，则此时就用`0x5561dc78`覆盖`getbuf`的返回地址。  
注入代码不足40字节，其余部分任意填充即可。

## Level 3
与Level 2类似，但此时需要在栈中存放字符串内容，而且要保证在调用`touch3`时，不能被覆盖。将字符串内容存在栈中的高位，然后移动`%rsp`。  
需要存入的字符串有9个字节，8个字符加一个空字符，可以存在`0x5561dc97-0x5561dc9f`中。在执行`touch3`前`%rsp`需要小于等于`0x5561dc97`，保证字符串不被覆盖。  
需要注入四行代码，分别是`mov`(字符串地址存入`%rdi`)，`sub`(下移`%rsp`)，`push`(`touch3`地址压栈)，`ret`。  
由于在`getbuf`返回时，返回地址弹出，此时`%rsp`为`0x5561dca8`，需要至少减去`0x11`。同时需要考虑`push`时可会覆盖栈中的值，不能覆盖掉注入的代码，否则指令会出错，要保证移动`%rsp`，再将其减去8后，值大于存放`ret`的地址。

# Return-Oriented Programming
在rtarget中，采用了栈地址随机化和栈中内容不可执行两种方法对抗缓冲区溢出攻击，这也使得之前向栈中注入代码的攻击无法实现。  
ROP利用了程序中原有的代码进行攻击。在栈存放的是返回地址，每一个地址指向一段代码，这段代码以ret结尾，这段代码叫做gadget。每次gadget的返回，栈就会弹出一个返回地址，使得程序进入下一个gadget。每个gadget中可能只有1、2个指令，但运用多个gadget就可以实现攻击者希望执行的内容。

## Level 2
要将cookie存入`%rdi`，并返回到`touch2`。cookie的值可以直接放在栈中，然后利用`pop`指令读入寄存器。在`farm`中可以找到`58 90 c3`这一串代码，正好对应`popq %rax`，`nop`，`ret`三个指令，将其作为一个gadget，将这一代码的地址作为返回地址入栈。之后，又可以找到`48 89 c7 c3`，对应`mov %rax, %rdi`，`ret`。这个两个gadget实现了将栈中的cookie值存入`%rdi`的操作。  
输入的字符串应是：40个填充字符，gadget1的地址，cookie值(8B)，gadget2的地址，touch2的地址。

## Level 3
`touch3`中需要将cookie作为字符串输入，所以必须确定字符串的地址。输入值只能放在栈中，所以需要得到`%rsp`。而随着gadget的运行，`%rsp`需要不断地变化，而且要保证在运行`touch3`时，字符串不被覆盖。那么，字符串应该位置应该高于`touch3`地址的位置。  
在`farm`中有`lea (%rdi, %rsi, 1), %rax`指令，这样可以用基地址+偏移的方法得到字符串地址。  
先将`%rsp`的值存到`%rdi`，这里需要两个gadget，`%rsp`先存到`%rax`再存到`%rdi`。  
之后从栈中取出偏移量的值，再存到`%rsi`，这里需要4个gadget。先`pop`到`%rax`，然后从`%eax`移到`%edx`再到`%ecx`最后到`%esi`。因为找不到直接mov的指令，所以需要借助多个寄存器。  
`%rdi`和`%rsi`中的值都准备好后，用`lea`指令，再用一个gadget将`%rax`赋给`%rdi`。此时完成了参数的准备。最后写入`touch3`的地址以及对应的kcookie字符串。